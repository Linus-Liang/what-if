<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
  </head>
  <body>
    <!-- <div data-bind="foreach: { data: gradedStudents, as: 'student' }">
      <table>
        <tbody data-bind="foreach: student">
          <div data-bind="text: JSON.stringify( $data)"></div>
        </tbody>
      </table>
    </div> -->

    <table>
      <tbody>
        <tr>
          <td><h5>Assignment Name</h5></td>
          <td><h5>Score</h5></td>
          <td><h5>Points</h5></td>
          <td><h5>Percentage</h5></td>
        </tr>
      </tbody>
      <tbody data-bind="foreach: { data: assignments, as: 'assignment' }">
        <tr>
          <td data-bind="text: assignment.name"></td>
          <td>
            <span data-bind="text: assignment.earnedScore"></span>/
            <span data-bind="text: assignment.maxScore"></span>
          </td>
          <td>
            <span data-bind="text: assignment.earnedPoints"></span>/
            <span data-bind="text: assignment.points"></span>
          </td>
          <td>
            <span data-bind="text: assignment.grade * 100"></span>%
          </td>
        </tr>
      </tbody>
    </table>

    <style>
      table, tr, td {
        border: 1px solid black;
      }
    </style>

    <script src="utils.js"></script>
    <script src="grader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    <script src="test.js"></script>
    <script>
      function viewModel(students, categories, assignments, grades, scoreCodes) {
        const grader = new GradingService();
        
        const gradedAssignments = grader.gradeAssignments(assignments, grades, scoreCodes);
        const averagedStudents = grader.averageStudents(students, categories, gradedAssignments);

        this.assignments = ko.observableArray(assignments.map(a => {
          const calculatedGrade = gradedAssignments.find(ga => ga.assignmentId === a.id);
          const mergedAssignment = { ...a, ...calculatedGrade };
          mergedAssignment.earnedScore = ko.pureComputed(function() {
            return assignment.grade * assignment.maxScore;
          });
          console.log(mergedAssignment);
          
          return mergedAssignment;
        }));

        this.gradedStudents = ko.observableArray(averagedStudents.map(s => {
          return ko.observableArray(s.categories.map(ac => {
            ac.name = categories.find(c => ac.categoryId === c.id).name;
            return ac;
          }))
        }));
      }
      const view = new viewModel(testData.students, testData.categories, testData.assignments, testData.grades, testData.scoreCodes);
      ko.applyBindings(view);
    </script>

    
  </body>
</html>